# This is your "Infrastructure as Code" file for Render.
# It replaces your docker-compose.yml and defines all backend services.
# The 'ui' service is NOT included here, as it will be deployed on Vercel.

#
# --- NO DATABASE SECTION ---
# We are now using an external, always-on Supabase DB
#

services:
  # -----------------------------------------------------------------
  #  1. Eureka Server (Must be 'web' on free plan)
  # -----------------------------------------------------------------
  - type: web
    name: eureka-server
    runtime: docker
    dockerfilePath: ./eurekaserver/Dockerfile
    dockerContext: ./eurekaserver
    plan: free
    healthCheckPath: /
    envVars:
      - key: EUREKA_CLIENT_REGISTERWITHEUREKA
        value: false
      - key: EUREKA_CLIENT_FETCHREGISTRY
        value: false
      - key: SERVER_PORT
        value: 8761

  # -----------------------------------------------------------------
  #  2. API Gateway (Public Web Service)
  # -----------------------------------------------------------------
  - type: web
    name: apigateway
    runtime: docker
    dockerfilePath: ./apigateway/Dockerfile
    dockerContext: ./apigateway
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9100

  # -----------------------------------------------------------------
  #  3. User Service (Must be 'web' on free plan)
  # -----------------------------------------------------------------
  - type: web
    name: user-service
    runtime: docker
    dockerfilePath: ./user-service/Dockerfile
    dockerContext: ./user-service
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9101
      # --- NEW: Supabase Postgres Vars ---
      # These values are pulled from the Blueprint's environment
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  4. Shop Service
  # -----------------------------------------------------------------
  - type: web
    name: shop-service
    runtime: docker
    dockerfilePath: ./shopservice/Dockerfile
    dockerContext: ./shopservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9102
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  5. Product Service
  # -----------------------------------------------------------------
  - type: web
    name: product-service
    runtime: docker
    dockerfilePath: ./productservice/Dockerfile
    dockerContext: ./productservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9103
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  6. Cart Service
  # -----------------------------------------------------------------
  - type: web
    name: cart-service
    runtime: docker
    dockerfilePath: ./cartservice/Dockerfile
    dockerContext: ./cartservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9104
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  7. Order Service
  # -----------------------------------------------------------------
  - type: web
    name: order-service
    runtime: docker
    dockerfilePath: ./orderservice/Dockerfile
    dockerContext: ./orderservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9105
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  8. Profile Service
  # -----------------------------------------------------------------
  - type: web
    name: profile-service
    runtime: docker
    dockerfilePath: ./profileservice/Dockerfile
    dockerContext: ./profileservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9106
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  9. Cart Item Service
  # -----------------------------------------------------------------
  - type: web
    name: cart-item-service
    runtime: docker
    dockerfilePath: ./cartitem/Dockerfile
    dockerContext: ./cartitem
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9107
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

  # -----------------------------------------------------------------
  #  10. Order Item Service
  # -----------------------------------------------------------------
  - type: web
    name: order-item-service
    runtime: docker
    dockerfilePath: ./orderitem/Dockerfile
    dockerContext: ./orderitem
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9108
      # --- NEW: Supabase Postgres Vars ---
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      - key: SPRING_DATASOURCE_USERNAME
        value: ${DB_USER}
      - key: SPRING_DATASOURCE_PASSWORD
        value: ${DB_PASS}
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.PostgreSQLDialect

