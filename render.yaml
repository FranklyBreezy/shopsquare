# This is your "Infrastructure as Code" file for Render.
# It replaces your docker-compose.yml and defines all backend services.
# The 'ui' service is NOT included here, as it will be deployed on Vercel.

databases:
  # -----------------------------------------------------------------
  #  Create one shared MySQL database on the free tier
  # -----------------------------------------------------------------
  - name: shopsquare-mysql
    databaseName: shopsquare_db # All services will use this one DB
    plan: free # Use the free tier MySQL

services:
  # -----------------------------------------------------------------
  #  1. Eureka Server (Must be 'web' on free plan)
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: eureka-server
    runtime: docker
    dockerfilePath: ./eurekaserver/Dockerfile
    dockerContext: ./eurekaserver
    plan: free # Use the free tier
    healthCheckPath: / # Eureka's dashboard is a good health check
    envVars:
      - key: EUREKA_CLIENT_REGISTERWITHEUREKA
        value: false
      - key: EUREKA_CLIENT_FETCHREGISTRY
        value: false
      - key: SERVER_PORT
        value: 8761

  # -----------------------------------------------------------------
  #  2. API Gateway (Public Web Service)
  # -----------------------------------------------------------------
  - type: web # This MUST be 'web' to be public
    name: apigateway
    runtime: docker
    dockerfilePath: ./apigateway/Dockerfile
    dockerContext: ./apigateway
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        # Render services can talk to each other using their 'name' and port
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9100 # Render uses this variable to find the port

  # -----------------------------------------------------------------
  #  3. User Service (Must be 'web' on free plan)
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: user-service
    runtime: docker
    dockerfilePath: ./user-service/Dockerfile
    dockerContext: ./user-service
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9101
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  4. Shop Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: shop-service
    runtime: docker
    dockerfilePath: ./shopservice/Dockerfile
    dockerContext: ./shopservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9102
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  5. Product Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: product-service
    runtime: docker
    dockerfilePath: ./productservice/Dockerfile
    dockerContext: ./productservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9103
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  6. Cart Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: cart-service
    runtime: docker
    dockerfilePath: ./cartservice/Dockerfile
    dockerContext: ./cartservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9104
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  7. Order Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: order-service
    runtime: docker
    dockerfilePath: ./orderservice/Dockerfile
    dockerContext: ./orderservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9105
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  8. Profile Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: profile-service
    runtime: docker
    dockerfilePath: ./profileservice/Dockerfile
    dockerContext: ./profileservice
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9106
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  9. Cart Item Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: cart-item-service
    runtime: docker
    dockerfilePath: ./cartitem/Dockerfile
    dockerContext: ./cartitem
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9107
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

  # -----------------------------------------------------------------
  #  10. Order Item Service
  # -----------------------------------------------------------------
  - type: web # CHANGED from 'pserv' to 'web'
    name: order-item-service
    runtime: docker
    dockerfilePath: ./orderitem/Dockerfile
    dockerContext: ./orderitem
    plan: free
    healthCheckPath: /actuator/info
    envVars:
      - key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
        value: http://eureka-server:8761/eureka/
      - key: SERVER_PORT
        value: 9108
      # --- FIX: Manually build the JDBC URL ---
      - key: DB_HOST
        fromDatabase:
          name: shopsquare-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shopsquare-mysql
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shopsquare-mysql
          property: database
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
      # -----------------------------------------
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: shopsquare-mysql
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: shopsquare-mysql
          property: password
      # --- FIX: Add Dialect and Connection Timeout ---
      - key: SPRING_JPA_DATABASE-PLATFORM
        value: org.hibernate.dialect.MySQLDialect
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION-TIMEOUT
        value: 60000

